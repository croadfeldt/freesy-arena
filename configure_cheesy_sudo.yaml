- name: Configure sudo privileges for user 'cheesy'
  hosts: localhost  # Target all hosts that need this configuration
  become: true # Must run this playbook with root privileges

  vars:
    target_user: cheesy
    sudoers_file_path: "/etc/sudoers.d/99-{{ target_user }}-ansible"

  tasks:
    - name: Ensure the sudoers.d directory exists (standard configuration)
      ansible.builtin.file:
        path: /etc/sudoers.d
        state: directory
        mode: '0755'

    - name: Create or update the sudoers file snippet for user '{{ target_user }}'
      ansible.builtin.lineinfile:
        path: "{{ sudoers_file_path }}"
        line: "{{ target_user }} ALL=(ALL) NOPASSWD: ALL"
        create: true  # Create the file if it doesn't exist
        mode: '0440'  # Set secure permissions (read-only for owner/group)
        validate: 'visudo -cf %s' # Validate syntax with visudo before saving

    - name: Verify that the user '{{ target_user }}' exists
      ansible.builtin.user:
        name: "{{ target_user }}"
        state: present
      # This task ensures the user is present on the system before they can use the rule,
      # but it's optional if you know the user already exists.
